# Nginx reverse proxy for Next.js (Meoris Sandal)
# Copy this file to /etc/nginx/sites-available/meoris
# Then: sudo ln -s /etc/nginx/sites-available/meoris /etc/nginx/sites-enabled/meoris
#       sudo nginx -t && sudo systemctl reload nginx

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name meoris.erdanpee.com;

  # Update certificate paths to match your Let's Encrypt files
  ssl_certificate /etc/letsencrypt/live/meoris.erdanpee.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/meoris.erdanpee.com/privkey.pem;

  # Basic tuning (optional)
  client_max_body_size 20m;
  keepalive_timeout 65;
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  # Gzip (optional)
  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss image/svg+xml;
  gzip_vary on;

  # Proxy all routes (including /api) to Next.js on port 3000
  location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;

    # Important proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket upgrade (safe for Next.js)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Disable buffering for streaming responses
    proxy_buffering off;
  }

  # Next.js static/chunks (optional as separate location)
  location /_next/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_buffering off;
  }

  # Optional: cache public assets
  location ~* \.(?:ico|gif|jpe?g|png|webp|svg)$ {
    proxy_pass http://127.0.0.1:3000;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
  }

  location ~* \.(?:css|js)$ {
    proxy_pass http://127.0.0.1:3000;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
  }
}

# Redirect HTTP â†’ HTTPS
server {
  listen 80;
  listen [::]:80;
  server_name meoris.erdanpee.com;
  return 301 https://$host$request_uri;
}

